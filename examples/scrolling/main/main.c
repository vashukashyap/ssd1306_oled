#include <stdio.h>
#include <freertos/FreeRTOS.h>
#include <freertos/task.h>
#include <driver/gpio.h>
#include <driver/i2c_master.h>
#include "esp_err.h"
#include <esp_mac.h>
#include "ssd1306_oled.h"
#include <string.h>
#include <ssd1306_fonts.h>
#include <esp_timer.h>

static const uint8_t bitmap_panda[256] = {
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x3f, 0x3f, 0x7f, 0xbf, 0xbf, 0xbf, 0xbf, 0xbf, 0xbf, 0x7f,
    0x7f, 0x3f, 0x3f, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0x03, 0xfc, 0x8e, 0xc7, 0xf7, 0xbf, 0xbf, 0xff, 0xf7, 0xc7, 0x87, 0x8f, 0xff,
    0xfe, 0x7c, 0x72, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0x7f, 0x0e, 0x00, 0x01, 0x61, 0x39, 0x39, 0x39, 0x39, 0x38, 0x78, 0xfc, 0xfc, 0xfc,
    0xfe, 0xfe, 0xfe, 0x78, 0x87, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xfe, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfd, 0xfd, 0xfd, 0xfd,
    0xfe, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff};

void app_main(void)
{

    ssd1306_init_oled_i2c(0x3c, 21, 22); // init the i2c pin and address.
    ssd1306_oled_clear(0);               // clear the oled Graphic Ram and screen.

    font_pack *my_font = ssd1306_init_oled_font(&font_5x7[0][0], 5, 8, 32); // initalizing the font to use in oled_buffer

    oled_buffer *top_bar = ssd1306_create_viewbox(128, 2);      // create a small buffer of 128 colums and 2 page which is 128x(2x8) = 2048 bytes.
    oled_buffer *panda = ssd1306_create_viewbox(63, 4);         // create a small buffer of 63 colums and 4 page which is 63x(4x8) = 2016 bytes.
    oled_buffer *message = ssd1306_create_viewbox(30, 1);       // create a small buffer of 63 colums and 4 page which is 63x(4x8) = 2016 bytes.
    oled_buffer *bottom_bar = ssd1306_create_viewbox(128, 2);   // create a small buffer of 128 colums and 2 page which is 128x(2x8) = 2048 bytes.

    // placing the buffer at different position.

    ssd1306_place_oled_view(panda, 1,3);
    ssd1306_place_oled_view(message, 64,3);
    ssd1306_place_oled_view(bottom_bar, 1,7);

    ssd1306_draw_oled_string(top_bar, 3, "PANDA", my_font, 4);              // adding text in top buffer
    ssd1306_draw_oled_string(bottom_bar, 3, "ssd1306_oled", my_font, 4);    // adding text in bottom buffer

    ssd1306_viewbox_oled_border(top_bar, 0,1,0,0); // adding only bottom border to the buffer.
    ssd1306_viewbox_oled_border(bottom_bar, 1,0,0,0); // adding only top border to the buffer.

    ssd1306_scroll_oled_view(top_bar, HORIZONTAL_LEFT);
    ssd1306_scroll_oled_view(bottom_bar, HORIZONTAL_RIGHT);

    ssd1306_inset_oled_bitmap(panda, bitmap_panda, 256); // putting bitmap in the oled buffer.

    // displaying different buffer.

    ssd1306_send_oled_display_buffer(top_bar);
    ssd1306_send_oled_display_buffer(panda); 
    ssd1306_send_oled_display_buffer(message); 
    ssd1306_send_oled_display_buffer(bottom_bar); 


    while(1)
    {
        //generating the random values
        int rand_1_to_4 = (rand() % 4) + 1;     // random vlaue between 1 to 4
        int rand_1_to_44 = (rand() % 44) + 1;   // random vlaue between 1 to 98 , since we don't want our buffer to display outside the screen therefore we have subtracted 30 columns form 128 columns.
        

        ssd1306_place_oled_view(message, rand_1_to_44 + 64, rand_1_to_4 + 2);   // setting the buffer position on the screen in terms of columns and pages.

        ssd1306_draw_oled_string(message, 0, "Hi!", my_font, 1);    // writing the string in the buffer.
        ssd1306_send_oled_display_buffer(message);                     // sending the buffer to the oled

        vTaskDelay(2000/portTICK_PERIOD_MS);                            // delay for 2 seconds.
        
        ssd1306_oled_clear_view(message, 0);                           // clearing all the buffer values to 0x00
        ssd1306_send_oled_display_buffer(message);                     // sending the buffer to the oled
    }

}